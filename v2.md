# Closed Marketplace Data Ingestion Plan

## Context

Frame currently syncs data via APIs from 9 marketplaces. Indian marketplaces like **Meesho, Myntra, Nykaa, JioMart, Ajio, Udaan, IndiaMart** have no public seller APIs. We need alternative data ingestion methods so sellers on these platforms can use Frame.

**Goal**: 3-phase rollout â€” CSV Upload (MVP) â†’ Browser Extension â†’ Email Parsing.

Data from all methods lands in the **same UnifiedOrder/UnifiedProduct tables**, so existing metrics, alerts, AI chat, and briefings work automatically with zero changes.

---

## Phase 1: CSV Upload (MVP â€” Build Now)

### 1.1 Schema Changes

**File: `prisma/schema.prisma`**

Add 7 new marketplace types to enum:
```prisma
enum MarketplaceType {
  // ... existing 12 ...
  MEESHO
  MYNTRA
  NYKAA
  JIOMART
  AJIO
  UDAAN
  INDIAMART
}
```

Add `sourceType` field to UnifiedOrder and UnifiedProduct:
```prisma
model UnifiedOrder {
  // ... existing fields ...
  sourceType  String?  // null = API sync, "csv" = CSV upload, "extension" = browser ext, "email" = email parse
}

model UnifiedProduct {
  // ... existing fields ...
  sourceType  String?
}
```

New model to track CSV imports:
```prisma
model CsvImport {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectionId   String
  connection     MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  marketplace    MarketplaceType
  entity         String   // "orders" | "products"
  fileName       String
  fileHash       String   // SHA-256 of file contents â€” prevents duplicate imports
  totalRows      Int
  importedRows   Int      @default(0)
  skippedRows    Int      @default(0)
  errorRows      Int      @default(0)
  errors         Json?    // Array of { row: number, field: string, message: string }
  columnMapping  Json?    // User's confirmed column mapping
  status         String   @default("pending") // pending | processing | completed | failed
  createdAt      DateTime @default(now())
  completedAt    DateTime?

  @@unique([userId, fileHash])
  @@index([userId, marketplace])
}
```

### 1.2 New Dependency

```bash
npm install papaparse
npm install -D @types/papaparse
```

PapaParse â€” simple, battle-tested CSV parser. Works in Node.js, handles edge cases (quoted commas, multiline fields, BOM).

### 1.3 Per-Marketplace CSV Column Mappings

**File: `src/lib/csv/mappings.ts`** (new)

Each marketplace exports CSVs with different column headers. Define mappings with multiple alternative names per field (marketplaces change headers without notice):

```
MEESHO Orders:
  "Sub Order No" / "Order ID"          â†’ externalOrderId
  "Product Name"                        â†’ itemTitle
  "Quantity"                            â†’ quantity
  "Supplier Price" / "Order Amount"     â†’ totalAmount
  "Order Date"                          â†’ orderedAt
  "Order Status"                        â†’ status
  Currency: "INR" (hardcoded)

MYNTRA Orders:
  "Order No" / "Order Number"           â†’ externalOrderId
  "Style Name" / "Product Name"         â†’ itemTitle
  "Qty" / "Quantity"                    â†’ quantity
  "MRP" / "Selling Price"              â†’ totalAmount
  "Order Created On" / "Order Date"     â†’ orderedAt
  "Current Status"                      â†’ status
  Currency: "INR" (hardcoded)

NYKAA Orders:
  "Order ID"                            â†’ externalOrderId
  "Product Name"                        â†’ itemTitle
  "Qty"                                 â†’ quantity
  "Selling Price" / "Amount"            â†’ totalAmount
  "Order Date"                          â†’ orderedAt
  "Status"                              â†’ status
  Currency: "INR" (hardcoded)

JIOMART Orders:
  "Order Id" / "Order Number"           â†’ externalOrderId
  "Item Name" / "Product"               â†’ itemTitle
  "Quantity"                            â†’ quantity
  "Total Amount" / "Order Value"        â†’ totalAmount
  "Created Date" / "Order Date"         â†’ orderedAt
  "Order Status"                        â†’ status
  Currency: "INR" (hardcoded)

AJIO Orders:
  "Order Number"                        â†’ externalOrderId
  "Product Name" / "Style Name"         â†’ itemTitle
  "Quantity"                            â†’ quantity
  "Selling Price" / "Amount"            â†’ totalAmount
  "Order Date"                          â†’ orderedAt
  "Status"                              â†’ status
  Currency: "INR" (hardcoded)

UDAAN Orders:
  "Order ID"                            â†’ externalOrderId
  "Product Name"                        â†’ itemTitle
  "Qty" / "Quantity"                    â†’ quantity
  "Total Price" / "Amount"              â†’ totalAmount
  "Order Date" / "Created At"           â†’ orderedAt
  "Status"                              â†’ status
  Currency: "INR" (hardcoded)

INDIAMART Orders:
  "Query ID" / "Lead ID"               â†’ externalOrderId
  "Product Name"                        â†’ itemTitle
  "Quantity" (default: 1)               â†’ quantity
  "Estimated Order Value" (default: 0)  â†’ totalAmount
  "Date" / "Query Date"                 â†’ orderedAt
  Status: "PENDING" (default â€” leads)
  Currency: "INR" (hardcoded)
```

Product mappings follow a similar pattern (SKU, Title, Price, Stock/Inventory).

### 1.4 API Routes

#### `POST /api/import/preview` (new)
- Accepts multipart FormData: `file` (CSV) + `marketplace` (string)
- Validates: file type (CSV only), size (max 10MB), row count (max 50,000)
- Computes SHA-256 file hash â†’ checks CsvImport for duplicate
- Parses first 5 rows with PapaParse
- Auto-matches CSV columns to marketplace mapping
- Returns: `{ columns: [...], sampleRows: [...], suggestedMapping: {...}, totalRows: N }`

#### `POST /api/import/confirm` (new)
- Accepts JSON: `{ marketplace, fileHash, columnMapping, entity: "orders"|"products" }`
- Creates MarketplaceConnection (if first import for this marketplace)
- Creates CsvImport record with status "processing"
- Creates UnifiedSyncLog with trigger "manual"
- Parses full CSV, validates each row, upserts to UnifiedOrder/UnifiedProduct
- Skips rows with missing required fields (logs errors in CsvImport.errors)
- Returns: `{ importId, imported: N, skipped: N, errors: [...] }`

#### `GET /api/import/history` (new)
- Returns list of CsvImport records for the user
- Includes: marketplace, fileName, importedRows, errorRows, createdAt

### 1.5 Frontend Components

#### Import Page: `src/app/dashboard/import/page.tsx` (new)
Three-step flow:

**Step 1 â€” Upload**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Data                            â”‚
â”‚                                         â”‚
â”‚  Select Marketplace: [Meesho â–¼]         â”‚
â”‚                                         â”‚
â”‚  Import Type: â—‹ Orders  â—‹ Products      â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“ Drag & drop CSV file here   â”‚    â”‚
â”‚  â”‚     or click to browse          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  ğŸ’¡ Download from Meesho Seller Panel   â”‚
â”‚     â†’ Orders â†’ Download Report          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2 â€” Preview & Map**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preview Import â€” 1,234 rows found      â”‚
â”‚                                         â”‚
â”‚  Column Mapping:                        â”‚
â”‚  CSV "Sub Order No" â†’ [Order ID â–¼]      â”‚
â”‚  CSV "Product Name" â†’ [Item Title â–¼]    â”‚
â”‚  CSV "Order Amount" â†’ [Total Amount â–¼]  â”‚
â”‚  CSV "Order Date"   â†’ [Order Date â–¼]    â”‚
â”‚  CSV "Status"       â†’ [Status â–¼]        â”‚
â”‚                                         â”‚
â”‚  Sample Data (first 5 rows):            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Order  â”‚ Product   â”‚ Amt â”‚ Date â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ MSH001 â”‚ T-Shirt   â”‚ 499 â”‚ 2/15 â”‚    â”‚
â”‚  â”‚ MSH002 â”‚ Jeans     â”‚ 899 â”‚ 2/14 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  âš  3 rows have missing Order ID        â”‚
â”‚                                         â”‚
â”‚  [Cancel]              [Import 1,231 â†’] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 3 â€” Result**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Import Complete                     â”‚
â”‚                                         â”‚
â”‚  Imported: 1,231 orders                 â”‚
â”‚  Skipped:  3 (missing Order ID)         â”‚
â”‚  Duplicates: 45 (already imported)      â”‚
â”‚                                         â”‚
â”‚  [View Import History]  [Import More]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Per-Marketplace Help Text
Each marketplace gets a small instruction card showing where to download CSVs:
- **Meesho**: Supplier Panel â†’ Orders â†’ Download Report
- **Myntra**: Partner Portal â†’ Orders â†’ Export
- **Nykaa**: Seller Dashboard â†’ Orders â†’ Export CSV
- **JioMart**: Seller Portal â†’ My Orders â†’ Export
- **Ajio**: Seller Dashboard â†’ Orders â†’ Download
- **Udaan**: Seller Panel â†’ Orders â†’ Export CSV
- **IndiaMart**: Seller Dashboard â†’ Leads â†’ Download

### 1.6 Marketplace Config Updates

**File: `src/lib/marketplace/config.tsx`**

Add 7 new entries with logos:
- Meesho (#570D57)
- Myntra (#FF3F6C)
- Nykaa (#FC2779)
- JioMart (#0078AD)
- Ajio (#3B3B3B)
- Udaan (#8052EC)
- IndiaMart (#1A6DCC)

**File: `src/app/api/marketplaces/connect/route.ts`**

Add these to the marketplace switch â€” return `{ requiresCsv: true }` so frontend knows to show import flow instead of OAuth.

### 1.7 Sync Manager Updates

**File: `src/lib/sync/sync-manager.ts`**

Add CSV-only marketplaces to the exclusion list for cron sync (no API to poll):
```typescript
marketplace: {
  in: ["SHOPIFY", "EBAY", ...], // Only API-synced marketplaces
  notIn: ["MEESHO", "MYNTRA", "NYKAA", "JIOMART", "AJIO", "UDAAN", "INDIAMART"],
}
```

### 1.8 Data Freshness Indicator

Since CSV data can be stale, add visual indicators in the dashboard:
- API-synced: "Last synced 5 min ago" (green)
- CSV-imported: "Last imported 2 days ago â€” upload new CSV for latest data" (amber)

Uses existing `MarketplaceConnection.lastSyncAt` (set to import timestamp).

---

## Phase 2: Browser Extension (Semi-Automated)

**Architecture:**
```
Chrome Extension (installed by seller)
    â”‚
    â”œâ”€â”€ Content Script: Reads DOM on marketplace seller dashboard
    â”‚   (Meesho/Myntra/etc. orders page)
    â”‚
    â”œâ”€â”€ Background Script: Sends data to Frame API
    â”‚   POST /api/import/extension
    â”‚   Headers: { Authorization: Bearer <session-token> }
    â”‚
    â””â”€â”€ Popup UI: Shows sync status, last sync time
```

**Key decisions:**
- Extension requests permissions for: `https://supplier.meesho.com/*`, `https://partner.myntra.com/*` etc.
- Reads order/product tables from the DOM (CSS selectors per marketplace)
- Sends batches to Frame API every 15 minutes
- Uses same UnifiedOrder/UnifiedProduct upsert with `sourceType: "extension"`
- Seller authenticates extension with a one-time token from Frame dashboard

**How it works for the seller:**
1. Install Frame Chrome Extension from Chrome Web Store
2. Log into Frame dashboard â†’ Settings â†’ Generate Extension Token
3. Paste token into extension popup
4. Open Meesho/Myntra seller dashboard as usual
5. Extension silently reads order data and syncs to Frame in background
6. Dashboard shows "Last synced via extension: 5 min ago"

**Effort:** ~2-3 weeks. Build after CSV is live and validated.

---

## Phase 3: Email Parsing (Fully Automated)

**Architecture:**
```
Seller forwards marketplace emails â†’ Frame's inbound email address
    â”‚
    â”œâ”€â”€ Inbound email service (SendGrid Inbound Parse or Resend webhook)
    â”‚
    â”œâ”€â”€ POST /api/webhooks/email-inbound
    â”‚   Parses email body/subject for order data
    â”‚   Identifies marketplace from sender domain
    â”‚
    â””â”€â”€ Upserts to UnifiedOrder with sourceType: "email"
```

**Key decisions:**
- Each user gets a unique forwarding address: `orders-{userId}@import.frame.ai`
- Pattern-match sender domains: `*@meesho.com`, `*@myntra.com`, etc.
- Regex patterns per marketplace to extract order ID, amount, product name from email body
- Fallback: store unparseable emails for manual review

**How it works for the seller:**
1. Go to Frame Dashboard â†’ Settings â†’ Email Import
2. Copy unique email: `orders-abc123@import.frame.ai`
3. In Gmail, set up a filter: "From meesho.com â†’ Forward to orders-abc123@import.frame.ai"
4. Every order confirmation email gets auto-parsed and imported
5. Dashboard shows real-time order count updating as emails arrive

**Effort:** ~3-4 weeks. Build after browser extension is validated.

---

## Implementation Order (Phase 1)

| Step | What | Files | Effort |
|------|------|-------|--------|
| 1 | Add 7 marketplace types to Prisma enum + `sourceType` field + `CsvImport` model | `prisma/schema.prisma` | 30 min |
| 2 | Run migration | `prisma migrate dev` | 5 min |
| 3 | Install papaparse | `package.json` | 2 min |
| 4 | Create CSV column mappings for all 7 marketplaces | `src/lib/csv/mappings.ts` (new) | 1 hr |
| 5 | Create CSV parser + validator utility | `src/lib/csv/parser.ts` (new) | 1 hr |
| 6 | Create preview API route | `src/app/api/import/preview/route.ts` (new) | 1 hr |
| 7 | Create confirm/import API route | `src/app/api/import/confirm/route.ts` (new) | 2 hr |
| 8 | Create import history API route | `src/app/api/import/history/route.ts` (new) | 30 min |
| 9 | Add marketplace configs (logos, colors) | `src/lib/marketplace/config.tsx` | 30 min |
| 10 | Update connect route for CSV marketplaces | `src/app/api/marketplaces/connect/route.ts` | 15 min |
| 11 | Build import page (upload â†’ preview â†’ confirm) | `src/app/dashboard/import/page.tsx` (new) | 3 hr |
| 12 | Update sync-manager to skip CSV marketplaces | `src/lib/sync/sync-manager.ts` | 10 min |
| 13 | Add data freshness indicators to dashboard | Existing dashboard components | 30 min |
| 14 | Test end-to-end with sample Meesho/Myntra CSVs | Manual testing | 1 hr |

**Total Phase 1 estimate: ~12 hours of implementation**

---

## Verification Plan

1. **Schema**: Run `npx prisma migrate dev` â€” verify migration succeeds
2. **CSV Parse**: Upload a sample Meesho CSV â†’ verify preview shows correct columns
3. **Import**: Confirm import ï¿½ï¿½ verify UnifiedOrder rows created with `sourceType: "csv"` and `marketplace: "MEESHO"`
4. **Dedup**: Re-upload same file â†’ verify "duplicate file" error (fileHash check)
5. **Dedup rows**: Upload file with overlapping order IDs â†’ verify upsert (no duplicates)
6. **Metrics**: Check dashboard â†’ Meesho orders should appear in revenue totals
7. **Alerts**: Run alert cron â†’ verify Meesho products trigger stockout alerts
8. **AI Chat**: Ask Frax "How are my Meesho sales?" â†’ verify it includes CSV-imported data
9. **Briefing**: Verify weekly briefing includes all marketplace data
10. **Type check**: Run `npx tsc --noEmit` â€” no new errors
