// Frame Database Schema
// Prisma ORM for Multi-Marketplace Analytics Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER (CLIENT only)
// ============================================

model User {
  id String @id @default(cuid())

  // Profile information
  name     String
  email    String  @unique
  phone    String?
  city     String?
  state    String?
  zipCode  String?
  country  String?

  // Authentication
  passwordHash String

  // Password reset (stores hashed token for security)
  resetTokenHash   String?   @unique
  resetTokenExpiry DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription     Subscription?
  marketplaceConns MarketplaceConnection[]
  trialClient      SalesClient? @relation("trialClient")
  unifiedOrders    UnifiedOrder[]
  unifiedProducts  UnifiedProduct[]
  conversations    Conversation[]
  reports          Report[]

  @@index([email])
}

// ============================================
// EMPLOYEE (FOUNDER & SALES_MEMBER)
// ============================================

enum EmployeeRole {
  FOUNDER
  SALES_MEMBER
}

model Employee {
  id String @id @default(cuid())

  // Profile
  name  String
  email String @unique
  phone String?

  // Authentication
  passwordHash String

  // Role & access control
  role       EmployeeRole
  isApproved Boolean      @default(false)
  refCode        String?  @unique
  commissionRate Decimal? @db.Decimal(5, 2)

  // Password reset
  resetTokenHash    String?   @unique
  resetTokenExpiry  DateTime?
  mustChangePassword Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesClients SalesClient[]
  commissions  Commission[]

  @@index([email])
}

// ============================================
// MARKETPLACE CONNECTIONS
// ============================================

model MarketplaceConnection {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  marketplace MarketplaceType
  status      ConnectionStatus @default(PENDING)

  // OAuth tokens - SECURITY: These fields MUST be encrypted at rest using application-layer encryption.
  // Use @/lib/auth/encryption helpers (encryptToken/decryptToken) for all reads/writes.
  // Never store plaintext tokens. Consider migrating to a secrets manager for production.
  accessToken  String? // Encrypted OAuth access token - use encryptToken() before write, decryptToken() after read
  refreshToken String? // Encrypted OAuth refresh token - use encryptToken() before write, decryptToken() after read
  tokenExpiry  DateTime? // Token expiration timestamp (not encrypted, used for refresh scheduling)

  // Marketplace-specific data
  externalId    String?
  externalName  String?
  webhookSecret String? // Encrypted webhook signature key (Square, etc.) - use encryptToken() before write, decryptToken() after read

  // Sync control — uses CAS via updateMany with optimistic locking (syncLockVersion).
  // Stale locks older than 30 min (or with null syncStartedAt) are auto-reclaimed.
  syncInProgress  Boolean   @default(false) // Distributed sync lock — use atomic updateMany for CAS
  syncStartedAt   DateTime? // When current sync started — used to detect and release stale locks
  syncLockVersion Int       @default(0) // Monotonic version counter — prevents releasing another process's lock

  // Timestamps
  connectedAt       DateTime?
  lastSyncAt        DateTime? // Last successful sync completion
  lastSyncAttemptAt DateTime? // Last sync attempt (success or failure) — used for backoff
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Unified data relations
  unifiedOrders   UnifiedOrder[]
  unifiedProducts UnifiedProduct[]
  unifiedSyncLogs UnifiedSyncLog[]

  @@unique([userId, marketplace])
  @@index([userId])
}

enum MarketplaceType {
  SHOPIFY
  AMAZON
  EBAY
  ETSY
  WOOCOMMERCE
  BIGCOMMERCE
  WIX
  SQUARE
  MAGENTO
  PRESTASHOP
  FLIPKART
  SNAPDEAL
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

// ============================================
// SUBSCRIPTION
// ============================================

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status SubscriptionStatus @default(ACTIVE)

  // Pricing
  basePrice       Decimal @default(999) @db.Decimal(10, 2)
  additionalPrice Decimal @default(449) @db.Decimal(10, 2)
  totalPrice      Decimal @default(999) @db.Decimal(10, 2)

  // Connected marketplaces count for billing
  marketplaceCount Int @default(2)

  // Billing cycle
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime @default(dbgenerated("(NOW() + '30 days'::interval)")) // Default to 30 days from creation

  // Payment info (for Stripe integration later)
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Conversation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    MessageRole
  content String      @db.Text

  // For assistant messages
  queryData Json?

  // Attachments (files, audio recordings)
  attachments Attachment[]

  createdAt DateTime @default(now())

  @@index([conversationId])
}

model Attachment {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  type     String // "file" | "audio"
  name     String
  size     Int
  mimeType String
  url      String // Supabase Storage public URL
  path     String // Storage path for deletion

  createdAt DateTime @default(now())

  @@index([messageId])
}

enum MessageRole {
  USER
  ASSISTANT
}

// ============================================
// REPORTS
// ============================================

model Report {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type  ReportType
  title String

  // Date range
  startDate DateTime?
  endDate   DateTime?

  // Report content
  content Json
  summary String? @db.Text

  status ReportStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum ReportType {
  REVENUE_SUMMARY
  PRODUCT_ANALYSIS
  CUSTOMER_INSIGHTS
  FULL_ANALYSIS
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ============================================
// TRIAL REQUESTS
// ============================================

model TrialRequest {
  id    String  @id @default(cuid())
  name  String
  email String
  phone String?

  // Sales referral tracking
  refCode String?

  // Status tracking
  status TrialRequestStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesClient SalesClient?

  @@index([email])
  @@index([createdAt])
}

enum TrialRequestStatus {
  PENDING
  CONTACTED
  CONVERTED
  DECLINED
}

// ============================================
// SALES TEAM
// ============================================

model SalesClient {
  id            String   @id @default(cuid())
  salesMemberId String
  salesMember   Employee @relation(fields: [salesMemberId], references: [id], onDelete: Cascade)

  // Client info
  name  String
  email String
  phone String?

  status TrialRequestStatus @default(PENDING)

  // Optional link to TrialRequest (if came via referral link)
  trialRequestId String?       @unique
  trialRequest   TrialRequest? @relation(fields: [trialRequestId], references: [id])

  // Trial invitation
  trialToken  String?   @unique
  trialSentAt DateTime?

  // Link to actual user account created during trial setup
  clientUserId String? @unique
  clientUser   User?   @relation("trialClient", fields: [clientUserId], references: [id])

  commissions Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([salesMemberId])
  @@index([email])
}

model Commission {
  id            String   @id @default(cuid())
  salesMemberId String
  salesMember   Employee @relation(fields: [salesMemberId], references: [id], onDelete: Cascade)

  salesClientId String?
  salesClient   SalesClient? @relation(fields: [salesClientId], references: [id])

  amount Decimal @db.Decimal(10, 2)
  note   String?
  period String @default("INITIAL") // "YYYY-MM" for monthly commissions, "INITIAL" for initial purchase

  createdAt DateTime @default(now())

  @@unique([salesMemberId, salesClientId, period])
  @@index([salesMemberId])
}

// ============================================
// UNIFIED MARKETPLACE DATA
// ============================================

enum UnifiedOrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum UnifiedProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

model UnifiedOrder {
  id              String             @id @default(cuid())
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplace     MarketplaceType
  connectionId    String
  connection      MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  externalOrderId String
  status          UnifiedOrderStatus @default(PENDING)
  currency        String
  totalAmount     Decimal            @db.Decimal(10, 2)
  totalAmountUSD  Decimal?           @db.Decimal(10, 2)
  itemCount       Int                @default(0)
  customerName    String? // PII — MUST be encrypted at rest via encryptToken() before write, decryptToken() after read. NULLed by /api/cron/cleanup after 365 days. MUST NOT appear in logs.
  customerEmail   String? // PII — MUST be encrypted at rest via encryptToken() before write, decryptToken() after read. NULLed by /api/cron/cleanup after 365 days. MUST NOT appear in logs.
  orderedAt       DateTime
  fulfilledAt     DateTime?
  rawData         Json?
  syncedAt        DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  items UnifiedOrderItem[]

  @@unique([connectionId, externalOrderId])
  @@index([userId, marketplace])
  @@index([userId, orderedAt])
  @@index([connectionId])
}

model UnifiedProduct {
  id           String               @id @default(cuid())
  userId       String
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplace  MarketplaceType
  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  externalId   String
  title        String
  sku          String?
  category     String?
  price        Decimal              @db.Decimal(10, 2)
  currency     String
  inventory    Int                  @default(0)
  status       UnifiedProductStatus @default(ACTIVE)
  imageUrl     String?
  rawData      Json?
  syncedAt     DateTime             @default(now())
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  orderItems UnifiedOrderItem[]

  @@unique([connectionId, externalId])
  @@index([userId, marketplace])
  @@index([userId, sku])
  @@index([connectionId])
}

model UnifiedOrderItem {
  id             String          @id @default(cuid())
  orderId        String
  order          UnifiedOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId      String?
  product        UnifiedProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  externalItemId String
  title          String
  sku            String?
  quantity       Int
  unitPrice      Decimal         @db.Decimal(10, 2)
  totalPrice     Decimal         @db.Decimal(10, 2)
  currency       String
  createdAt      DateTime        @default(now())

  @@unique([orderId, externalItemId])
  @@index([orderId])
  @@index([productId])
}

model UnifiedSyncLog {
  id           String                @id @default(cuid())
  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  marketplace  MarketplaceType
  entity       String // "orders" | "products"
  status       String // "started" | "completed" | "failed"
  totalCount   Int?
  syncedCount  Int                   @default(0)
  errorMessage String?
  trigger      String                @default("cron") // "cron" | "webhook" | "manual"
  startedAt    DateTime              @default(now())
  completedAt  DateTime?

  @@index([connectionId])
  @@index([marketplace, startedAt])
}

// ============================================
// TOKEN REVOCATION (Session Blacklist)
// ============================================

model RevokedToken {
  id        String   @id @default(cuid())
  jti       String   @unique // JWT ID claim
  userId    String
  revokedAt DateTime @default(now())
  expiresAt DateTime // When the original token expires (for cleanup)

  @@index([userId])
  @@index([expiresAt]) // For periodic cleanup of expired entries
}

// ============================================
// AUDIT LOG (Auth Events)
// ============================================

enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  SESSION_CREATED
  SESSION_REVOKED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  MARKETPLACE_CONNECTED
  MARKETPLACE_DISCONNECTED
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?     // Null for failed login attempts by unknown users
  action    AuditAction
  ipAddress String?
  userAgent String?
  metadata  Json?       // Additional context (e.g., marketplace type, error details)
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt]) // For TTL/cleanup queries
}

// ============================================
// WEBHOOK EVENT DEDUPLICATION
// ============================================

model WebhookEvent {
  id          String          @id @default(cuid())
  marketplace MarketplaceType
  eventId     String          // Marketplace-provided event ID (from headers or payload)
  eventType   String          // e.g., "orders/create", "store/order/created"
  processedAt DateTime        @default(now())

  @@unique([marketplace, eventId])
  @@index([processedAt]) // For TTL/cleanup of old events
}
