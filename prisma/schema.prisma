// ShopIQ Database Schema
// Prisma ORM for Shopify Analytics App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER (CLIENT only)
// ============================================

model User {
  id String @id @default(cuid())

  // Profile information
  name     String
  email    String  @unique
  phone    String?
  city     String?
  state    String?
  zipCode  String?
  country  String?

  // Authentication
  passwordHash String

  // Password reset (stores hashed token for security)
  resetTokenHash   String?   @unique
  resetTokenExpiry DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stores           Store[]
  subscription     Subscription?
  marketplaceConns MarketplaceConnection[]
  trialClient      SalesClient? @relation("trialClient")
  unifiedOrders    UnifiedOrder[]
  unifiedProducts  UnifiedProduct[]

  @@index([email])
}

// ============================================
// EMPLOYEE (FOUNDER & SALES_MEMBER)
// ============================================

enum EmployeeRole {
  FOUNDER
  SALES_MEMBER
}

model Employee {
  id String @id @default(cuid())

  // Profile
  name  String
  email String @unique
  phone String?

  // Authentication
  passwordHash String

  // Role & access control
  role       EmployeeRole
  isApproved Boolean      @default(false)
  refCode        String?  @unique
  commissionRate Decimal? @db.Decimal(5, 2)

  // Password reset
  resetTokenHash    String?   @unique
  resetTokenExpiry  DateTime?
  mustChangePassword Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesClients SalesClient[]
  commissions  Commission[]

  @@index([email])
}

// ============================================
// MARKETPLACE CONNECTIONS
// ============================================

model MarketplaceConnection {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  marketplace MarketplaceType
  status      ConnectionStatus @default(PENDING)

  // OAuth tokens - SECURITY: These fields MUST be encrypted at rest using application-layer encryption.
  // Use @/lib/auth/encryption helpers (encryptToken/decryptToken) for all reads/writes.
  // Never store plaintext tokens. Consider migrating to a secrets manager for production.
  accessToken  String? // Encrypted OAuth access token - use encryptToken() before write, decryptToken() after read
  refreshToken String? // Encrypted OAuth refresh token - use encryptToken() before write, decryptToken() after read
  tokenExpiry  DateTime? // Token expiration timestamp (not encrypted, used for refresh scheduling)

  // Marketplace-specific data
  externalId    String?
  externalName  String?
  webhookSecret String? // Encrypted webhook signature key (Square, etc.) - use encryptToken() before write, decryptToken() after read

  // Timestamps
  connectedAt       DateTime?
  lastSyncAt        DateTime? // Last successful sync completion
  lastSyncAttemptAt DateTime? // Last sync attempt (success or failure) — used for backoff
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Unified data relations
  unifiedOrders   UnifiedOrder[]
  unifiedProducts UnifiedProduct[]
  unifiedSyncLogs UnifiedSyncLog[]

  @@unique([userId, marketplace])
  @@index([userId])
}

enum MarketplaceType {
  SHOPIFY
  AMAZON
  EBAY
  ETSY
  WOOCOMMERCE
  BIGCOMMERCE
  WIX
  SQUARE
  MAGENTO
  PRESTASHOP
  FLIPKART
  SNAPDEAL
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

// ============================================
// SUBSCRIPTION
// ============================================

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status SubscriptionStatus @default(ACTIVE)

  // Pricing
  basePrice       Decimal @default(19.99) @db.Decimal(10, 2)
  additionalPrice Decimal @default(4.99) @db.Decimal(10, 2)
  totalPrice      Decimal @default(19.99) @db.Decimal(10, 2)

  // Connected marketplaces count for billing
  marketplaceCount Int @default(1)

  // Billing cycle
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime @default(dbgenerated("(NOW() + '30 days'::interval)")) // Default to 30 days from creation

  // Payment info (for Stripe integration later)
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
}

// ============================================
// STORE (Shopify Connection)
// ============================================

model Store {
  id String @id @default(cuid())

  // Link to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Shopify identifiers
  shopifyId String  @unique
  domain    String  @unique // my-store.myshopify.com
  name      String
  email     String?
  currency  String  @default("USD")
  timezone  String  @default("UTC")

  // Auth
  accessToken String? // Nullable to allow clearing on disconnect
  scope       String

  // Sync status
  syncStatus     SyncStatus @default(PENDING)
  lastSyncedAt   DateTime?
  ordersCount    Int        @default(0)
  productsCount  Int        @default(0)
  customersCount Int        @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders        Order[]
  products      Product[]
  customers     Customer[]
  conversations Conversation[]
  reports       Report[]
  syncLogs      SyncLog[]

  @@index([userId])
}

enum SyncStatus {
  PENDING
  SYNCING
  COMPLETED
  FAILED
}

model SyncLog {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  entity       String // "orders" | "products" | "customers"
  status       String // "started" | "in_progress" | "completed" | "failed"
  totalCount   Int?
  syncedCount  Int     @default(0)
  errorMessage String?

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([storeId])
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId   String
  title       String
  handle      String?
  productType String?
  vendor      String?
  status      String  @default("active")

  // Pricing
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPerItem    Decimal? @db.Decimal(10, 2)

  // Inventory
  totalInventory Int @default(0)

  // Images
  imageUrl String?

  // Timestamps
  shopifyCreatedAt DateTime?
  shopifyUpdatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  variants  ProductVariant[]
  lineItems LineItem[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  shopifyId         String
  title             String
  sku               String?
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  costPerItem       Decimal? @db.Decimal(10, 2)
  inventoryQuantity Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineItems LineItem[]

  @@unique([productId, shopifyId])
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId String
  email     String?
  firstName String?
  lastName  String?
  phone     String?

  // Location
  city     String?
  province String?
  country  String?

  // Stats
  ordersCount Int     @default(0)
  totalSpent  Decimal @default(0) @db.Decimal(10, 2)

  // Marketing
  acceptsMarketing Boolean @default(false)

  // Tags
  tags String?

  // Timestamps
  shopifyCreatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  orders Order[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
  @@index([email])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId   String
  orderNumber Int
  name        String // e.g., "#1001"

  // Financials
  totalPrice     Decimal @db.Decimal(10, 2)
  subtotalPrice  Decimal @db.Decimal(10, 2)
  totalTax       Decimal @default(0) @db.Decimal(10, 2)
  totalDiscounts Decimal @default(0) @db.Decimal(10, 2)
  totalShipping  Decimal @default(0) @db.Decimal(10, 2)
  currency       String  @default("USD")

  // Status
  financialStatus   String?
  fulfillmentStatus String?

  // Customer
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerEmail String?

  // Source
  sourceName String?

  // Location
  shippingCity     String?
  shippingProvince String?
  shippingCountry  String?

  // Timestamps
  shopifyCreatedAt DateTime
  shopifyUpdatedAt DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  lineItems LineItem[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
  @@index([shopifyCreatedAt])
  @@index([customerId])
}

model LineItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Product reference
  productId String?
  product   Product?        @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Shopify IDs
  shopifyProductId String?
  shopifyVariantId String?

  // Item details
  title         String
  variantTitle  String?
  sku           String?
  quantity      Int
  price         Decimal @db.Decimal(10, 2)
  totalDiscount Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Conversation {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  title String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@index([storeId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    MessageRole
  content String      @db.Text

  // For assistant messages
  queryData Json?

  // Attachments (files, audio recordings)
  attachments Attachment[]

  createdAt DateTime @default(now())

  @@index([conversationId])
}

model Attachment {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  type     String // "file" | "audio"
  name     String
  size     Int
  mimeType String
  url      String // Supabase Storage public URL
  path     String // Storage path for deletion

  createdAt DateTime @default(now())

  @@index([messageId])
}

enum MessageRole {
  USER
  ASSISTANT
}

// ============================================
// REPORTS
// ============================================

model Report {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  type  ReportType
  title String

  // Date range
  startDate DateTime?
  endDate   DateTime?

  // Report content
  content Json
  summary String? @db.Text

  status ReportStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
}

enum ReportType {
  REVENUE_SUMMARY
  PRODUCT_ANALYSIS
  CUSTOMER_INSIGHTS
  FULL_ANALYSIS
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ============================================
// TRIAL REQUESTS
// ============================================

model TrialRequest {
  id    String  @id @default(cuid())
  name  String
  email String
  phone String?

  // Sales referral tracking
  refCode String?

  // Status tracking
  status TrialRequestStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesClient SalesClient?

  @@index([email])
  @@index([createdAt])
}

enum TrialRequestStatus {
  PENDING
  CONTACTED
  CONVERTED
  DECLINED
}

// ============================================
// SALES TEAM
// ============================================

model SalesClient {
  id            String   @id @default(cuid())
  salesMemberId String
  salesMember   Employee @relation(fields: [salesMemberId], references: [id], onDelete: Cascade)

  // Client info
  name  String
  email String
  phone String?

  status TrialRequestStatus @default(PENDING)

  // Optional link to TrialRequest (if came via referral link)
  trialRequestId String?       @unique
  trialRequest   TrialRequest? @relation(fields: [trialRequestId], references: [id])

  // Trial invitation
  trialToken  String?   @unique
  trialSentAt DateTime?

  // Link to actual user account created during trial setup
  clientUserId String? @unique
  clientUser   User?   @relation("trialClient", fields: [clientUserId], references: [id])

  commissions Commission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([salesMemberId])
  @@index([email])
}

model Commission {
  id            String   @id @default(cuid())
  salesMemberId String
  salesMember   Employee @relation(fields: [salesMemberId], references: [id], onDelete: Cascade)

  salesClientId String?
  salesClient   SalesClient? @relation(fields: [salesClientId], references: [id])

  amount Decimal @db.Decimal(10, 2)
  note   String?
  period String @default("INITIAL") // "YYYY-MM" for monthly commissions, "INITIAL" for initial purchase

  createdAt DateTime @default(now())

  @@unique([salesMemberId, salesClientId, period])
  @@index([salesMemberId])
}

// ============================================
// UNIFIED MARKETPLACE DATA
// ============================================

enum UnifiedOrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum UnifiedProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

model UnifiedOrder {
  id              String             @id @default(cuid())
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplace     MarketplaceType
  connectionId    String
  connection      MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  externalOrderId String
  status          UnifiedOrderStatus @default(PENDING)
  currency        String
  totalAmount     Decimal            @db.Decimal(10, 2)
  totalAmountUSD  Decimal?           @db.Decimal(10, 2)
  itemCount       Int                @default(0)
  customerName    String? // PII — subject to data retention policy. SECURITY: Consider application-layer encryption (AES-256-GCM via encryptToken/decryptToken in src/lib/shopify/oauth.ts) for at-rest protection, consistent with MarketplaceConnection token fields. NULLed by /api/cron/cleanup after retention period.
  customerEmail   String? // PII — subject to data retention policy. SECURITY: Same encryption guidance as customerName above. NULLed by /api/cron/cleanup after retention period.
  orderedAt       DateTime
  fulfilledAt     DateTime?
  rawData         Json?
  syncedAt        DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  items UnifiedOrderItem[]

  @@unique([connectionId, externalOrderId])
  @@index([userId, marketplace])
  @@index([userId, orderedAt])
  @@index([connectionId])
}

model UnifiedProduct {
  id           String               @id @default(cuid())
  userId       String
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplace  MarketplaceType
  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  externalId   String
  title        String
  sku          String?
  category     String?
  price        Decimal              @db.Decimal(10, 2)
  currency     String
  inventory    Int                  @default(0)
  status       UnifiedProductStatus @default(ACTIVE)
  imageUrl     String?
  rawData      Json?
  syncedAt     DateTime             @default(now())
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  orderItems UnifiedOrderItem[]

  @@unique([connectionId, externalId])
  @@index([userId, marketplace])
  @@index([userId, sku])
  @@index([connectionId])
}

model UnifiedOrderItem {
  id             String          @id @default(cuid())
  orderId        String
  order          UnifiedOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId      String?
  product        UnifiedProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  externalItemId String
  title          String
  sku            String?
  quantity       Int
  unitPrice      Decimal         @db.Decimal(10, 2)
  totalPrice     Decimal         @db.Decimal(10, 2)
  currency       String
  createdAt      DateTime        @default(now())

  @@unique([orderId, externalItemId])
  @@index([orderId])
  @@index([productId])
}

model UnifiedSyncLog {
  id           String                @id @default(cuid())
  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  marketplace  MarketplaceType
  entity       String // "orders" | "products"
  status       String // "started" | "completed" | "failed"
  totalCount   Int?
  syncedCount  Int                   @default(0)
  errorMessage String?
  trigger      String                @default("cron") // "cron" | "webhook" | "manual"
  startedAt    DateTime              @default(now())
  completedAt  DateTime?

  @@index([connectionId])
  @@index([marketplace, startedAt])
}

// ============================================
// TOKEN REVOCATION (Session Blacklist)
// ============================================

model RevokedToken {
  id        String   @id @default(cuid())
  jti       String   @unique // JWT ID claim
  userId    String
  revokedAt DateTime @default(now())
  expiresAt DateTime // When the original token expires (for cleanup)

  @@index([userId])
  @@index([expiresAt]) // For periodic cleanup of expired entries
}

// ============================================
// AUDIT LOG (Auth Events)
// ============================================

enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  SESSION_CREATED
  SESSION_REVOKED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  MARKETPLACE_CONNECTED
  MARKETPLACE_DISCONNECTED
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?     // Null for failed login attempts by unknown users
  action    AuditAction
  ipAddress String?
  userAgent String?
  metadata  Json?       // Additional context (e.g., marketplace type, error details)
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt]) // For TTL/cleanup queries
}

// ============================================
// WEBHOOK EVENT DEDUPLICATION
// ============================================

model WebhookEvent {
  id          String          @id @default(cuid())
  marketplace MarketplaceType
  eventId     String          // Marketplace-provided event ID (from headers or payload)
  eventType   String          // e.g., "orders/create", "store/order/created"
  processedAt DateTime        @default(now())

  @@unique([marketplace, eventId])
  @@index([processedAt]) // For TTL/cleanup of old events
}
